#!/bin/bash

# Usage: this-run [--label LABEL]
# Ex: this-run --label MY-RUN
#  1. Invoke run.sh
#  2. Move the results to under current dir i.e ./run-MY-RUN-2021-11-27-05:02:26/
#  4. Generate summary :
#        show-summary-MY-RUN--2021-11-27_05:02:31--b50b3953-2aa8-4b31-b22b-2fd49254cfcb.txt
#        summary-MY-RUN--2021-11-27_05:02:31--b50b3953-2aa8-4b31-b22b-2fd49254cfcb.txt
#  5. Tar the result blob
#

source /home/hnhan/bin/functions.sh

if [ -f ./thislabel ]; then
    LABEL=$(cat ./thislabel)
fi


function f_help {
    me=`basename "$0"` 
    echo Usage: $me "[--label <day-label>]"
}


LABEL=""
longopts="label:,help"
opts=$(getopt -q -o "" --longoptions "$longopts" -n "getopt.sh" -- "$@");
if [ $? -ne 0 ]; then
    echo "Unrecognized option specified"
    exit
fi
eval set -- "$opts";
while true; do
    case "$1" in
        --label)
            shift;
            LABEL=$1
            shift;
            ;;
        --)
            shift;
            break
            ;;
        --help)
            shift;
            f_help
            exit
            ;;

        *)
            echo "Invalid option: $1"
            exit
    esac
done

if [ "$LABEL" == "" ]; then
    f_help
    exit

fi

DIR="run-${LABEL}-$(date "+%Y-%m-%d-%T")"
#DIR="run-std-00-2022-06-12-23:08:43"
echo $DIR

if [ ! -d  $DIR ]; then
    mkdir $DIR
fi

echo "working dir" $(pwd)
# crucible es init
bash run.sh 2>&1 | tee $DIR.log
result_path=$(realpath /var/lib/crucible/run/latest)
mv $result_path $DIR/
pushd $DIR

#gen-summary $DIR
#tar-result $DIR

gen-summary 
echo tar-result iperf

popd
# EOF

