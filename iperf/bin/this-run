#!/bin/bash

# Usage: this-run [-l LABEL]
# Ex: this-run -l MY-RUN
#  1. Invoke run.sh
#  2. Move the results to under current dir i.e ./run-MY-RUN-2021-11-27-05:02:26/
#  4. Generate summary :
#        show-summary-MY-RUN--2021-11-27_05:02:31--b50b3953-2aa8-4b31-b22b-2fd49254cfcb.txt
#        summary-MY-RUN--2021-11-27_05:02:31--b50b3953-2aa8-4b31-b22b-2fd49254cfcb.txt
#  5. Tar the result blob
#

source /home/hnhan/bin/functions.sh

if [ -f ./thislabel ]; then
    LABEL=$(cat ./thislabel)
fi

while getopts "l:" option; do
    case "${option}" in
        l) 
            LABEL=${OPTARG}
            ;;
        :)
            echo "Error: -${OPTARG} requires an argument."
            exit
            ;;
        *)  # If unknown (any other) option:
            exit
            ;;
    esac
done

DIR="run-${LABEL}-$(date "+%Y-%m-%d-%T")"
echo $DIR
if [ ! -d  $DIR ]; then
    mkdir $DIR
fi

echo "working dir" $(pwd)
#crucible es init
bash run.sh 2>&1 | tee $DIR.log
result_path=$(realpath /var/lib/crucible/run/latest)
mv $result_path $DIR/
pushd $DIR

gen-summary $1
tar-result $1
popd
# EOF

